#Demonstrates problem with MLLP response from forward.
# Remove setProperty to fail.
- route:
    id: MllpSSLForwardingRoute
    from:
      # {{ enclosed }} values defined in application.yaml
      uri: "mllp://{{camel.mllp.ssl.inbound.host}}:{{camel.mllp.ssl.inbound.port}}?autoAck=false&sslContextParameters=#mysslContextParameters"
      steps:
        # Capture message body in header
        # so body can become an insert statement for jdbc
        - setHeader:
            name: originalBody
            simple: "${body}"
        - setHeader:
            name: camelRoute
            simple: "MllpSSLForwardingRoute"
        - setBody:
            simple: "INSERT INTO mytable (route, name, value) VALUES ('${header.camelRoute}', 'body', '${header.originalBody}')"
        # Call jdbc *************************************************
        # (this requires that you have a SQLite file named mydata.db
        # with a table mytable that has route, name, and value fields)
        # The call is commented out so that lack of that file does not
        # prevent this route from running.
        #- to: "jdbc:dataSource"
        # **********************************************************
        # Restore the original body
        - setBody:
            simple: "${header.originalBody.toString()}"
        # {{ enclosed }} values defined in application.yaml
        # Ssl using params from Java bean mysslContextParameters
        - to: "mllp://{{camel.mllp.ssl.outbound.host}}:{{camel.mllp.ssl.outbound.port}}?autoAck=false&sslContextParameters=#mysslContextParameters"
        - log:
            message: "Body: ${body.replaceAll('\\r','\\n')}"
        - log:
            message: "No set exchangeProp CamelMllpAcknowledgementString:\n${exchangeProperty.CamelMllpAcknowledgementString.replaceAll('\\r','\\n')}"
        - log:
            message: "But got header CamelMllpAcknowledgementString:\n${headers.CamelMllpAcknowledgementString.replaceAll('\\r','\\n')}"
        - log: "Set exchangeProperty to header value."
        - setProperty:
            name: "CamelMllpAcknowledgementString"
            simple: "${header.CamelMllpAcknowledgementString}"
        - log:
            message: "Body: ${body.replaceAll('\\r','\\n')}"
        - log:
            message: "exchangeProperty set from header:\n${exchangeProperty.CamelMllpAcknowledgementString.replaceAll('\\r','\\n')}"
